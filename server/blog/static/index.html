
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      o2js.com
      
      
    </title>
    <meta name="description" content="">
    <meta name="author" content="Volkan Özçelik">
    <meta name="viewport" content="width=device-width" />

    <link href="/css/style.css" rel="stylesheet" />

    <!-- The fav and touch icons -->
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  </head>
  <body class="main">
    <header class="meta">
      
        <a href="/" class="btn btn-grey">Volkan Özçelik</a>
      
      
        <a href="http://twitter.com/linkibol" class="btn btn-grey">@linkibol</a>
      
      
    </header>
    <div class="container">
      
<h2 class="title span8"><a href="/the-setup">The Setup</a></h2>
<div class="span8">
  <p>As I&#39;ve promised <a href="http://blog.o2js.com/hello-node-js-blogging-world">in the last post</a>, I&#39;ll go into the details of the overall architecture of this site.</p>
<blockquote>
<p>Although the steps defined in this article is specific to my needs, it can be helpful in general too. We will cover concepts like <strong>how to create a reverse proxy using IIS7</strong>, <strong>how to install and configure NGINX</strong>, <strong>how to configure virtualbox</strong>, <strong>how to do port forwarding to a local virtual machine</strong>… and the like.</p>
</blockquote>
<p>Let&#39;s begin by setting up <strong>IIS</strong>:</p>
<h3>Configuring IIS7</h3>
<p>Our goal will be to forward all the requests that come to <strong>blog.o2js.com</strong> to a local port, hoping that there&#39;s somebody at that port listening to the requests.</p>
<p>So, the first thing is to open <strong>IIS Manager</strong>, and create a website with the following bindings:</p>
<p><a href="http://blog.o2js.com/assets/bindings_large.png"><img src="http://blog.o2js.com/assets/bindings.png" alt="IIS7 bindings"></a></p>
<p>And here&#39;s the <strong>web.config</strong> file in the site&#39;s root directory:</p>
<pre>
&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;configuration>
    &lt;system.web>
        &lt;sessionState mode="Off" />
    &lt;/system.web>
    &lt;system.webServer>
        &lt;rewrite>
            &lt;rules>
                &lt;rule name="ReverseProxyInboundRule1" stopProcessing="true">
                    &lt;match url="(.*)" />
                    &lt;action type="Rewrite" url="http://localhost:8001/{R:1}" />
                &lt;/rule>
            &lt;/rules>
        &lt;/rewrite>
    &lt;/system.webServer>
&lt;/configuration>
</pre>

<p>This site will simply act as a proxy, forwarding any request that comes to it to <strong>localhost:8001</strong>.</p>
<blockquote>
<p>I have also <strong>blocked external access to port 8001</strong> using <strong>windows firewall</strong>. Since the forwarding is done to a local address only, the outside world does not need to access port 8001.</p>
</blockquote>
<p>That&#39;s all for the <strong>IIS</strong> part. The next thing is to set up the <em>virtual machine</em>:</p>
<h3>Configuring VirtualBox</h3>
<p><a href="https://www.virtualbox.org/">VirtualBox</a> is a powerful <strong>x86</strong> and <strong>AMD64/Intel64</strong> <a href="http://en.wikipedia.org/wiki/Virtualization">virtualization</a> product. I am running an <a href="http://www.ubuntu.com/desktop">64 bit ubuntu virtual machine</a> inside the virtualbox that I&#39;ve installed to my windows server.</p>
<p><a href="http://blog.o2js.com/assets/virtualbox_large.png"><img src="http://blog.o2js.com/assets/virtualbox.png" alt="virtualbox"></a></p>
<p><a href="http://www.wikihow.com/Install-Ubuntu-on-VirtualBox">Installing an operating system into virtualbox</a> is pretty straightforward.</p>
<p>After installing the OS (<em>which is <strong>ubuntu</strong> in my case</em>), I defined the following <strong><a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a></strong> rules:</p>
<p><a href="http://blog.o2js.com/assets/nat_large.png"><img src="http://blog.o2js.com/assets/nat.png" alt="NAT rules"></a></p>
<p>Here&#39;s what I do:</p>
<ul>
<li>I occasionally run <strong><a href="https://github.com/techwraith/scotch">scotch</a></strong> to create static files of this blog (<em>more on that later</em>).</li>
<li>I am forwarding <strong>port 22</strong> to <strong>SSH</strong> to this virtual machine from outside.</li>
<li>I am forwarding <strong>port 8001</strong> so that any request to <em>port 8001</em> of the <em>host machine</em> directly goes to this virtual server (i.e. the <em>guest machine</em>) – This sets the receiving endpoint of the redirect rule that we&#39;ve set up in the <strong>web.config</strong> above.</li>
</ul>
<p>The next thing is setting up <strong>NGINX</strong>:</p>
<h3>SSH</h3>
<p>After forwarding ports, we can <strong>SSH</strong> to the virtual server via <code>ssh -l {username} -p 22 {serverip}</code> command.</p>
<p>Here&#39;s how the server looks like right now:</p>
<p><a href="http://blog.o2js.com/assets/server_large.png"><img src="http://blog.o2js.com/assets/server.png" alt="htop"></a></p>
<p>Not bad for a virtual server, huh <strong>;)</strong>?</p>
<h3>Configuring NGINX</h3>
<p>Installing <strong><a href="http://nginx.org">NGINX</a></strong> is as easy as running <code>sudo apt-get install nginx</code>.</p>
<p>After installing <strong>NGINX</strong>, I&#39;ve created this <strong>nginx.conf</strong>:</p>
<pre>
user www-data;
worker_processes 4;
pid /run/nginx.pid;

events {
  worker_connections 768;
}

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  gzip on;
  gzip_disable "msie6";

  include /etc/nginx/conf.d/*.conf;
  include /etc/nginx/sites-enabled/*;

    server {
        listen          8001;
        server_name     blog.o2js.com;
        access_log      logs/blog.o2js.com.access.log;
        root            /home/volkan/PROJECTS/o2js.com/server/blog/static;

        # rewrite_log on;
        rewrite ^/$           /index.html;
        rewrite ^([^.]+)$     $1.html;
    }
}
</pre>

<p>This is the most basic configuration file that you can start with.</p>
<p>The rewrite rules</p>
<pre>
rewrite ^/$           /index.html;
rewrite ^([^.]+)$     $1.html;
</pre>

<p>Are there to map <strong>blog.o2js.com/article_goes_here.html</strong> links to <strong>blog.o2js.com/article_goes_here</strong> (<em>without the </em>.html* extension), which is cleaner.</p>
<p>And we haven&#39;t created <em>/home/volkan/PROJECTS/o2js.com/server/blog/static</em> folder yet. That&#39;s the next thing we&#39;ll do:</p>
<h3>Creating the Project Folder</h3>
<p>The source code of this blog (<em>along with markdown versions of all of the articles in it</em>) <a href="https://github.com/v0lkan/o2js.com">can be cloned at github</a>.</p>
<pre>
$: cd /home/volkan/PROJECTS/
$: git clone https://github.com/v0lkan/o2js.com.git
</pre>

<h3>Installing Scotch</h3>
<p><a href="https://github.com/techwraith/scotch">Scotch</a> is a dead-simple, <a href="http://daringfireball.net/projects/markdown/">markdown</a>-based blogging framework for <a href="http://nodejs.org/">node.js</a>.</p>
<p>Installing <strong>scotch</strong> is really easy:</p>
<pre>
$: cd /home/volkan/PROJECTS/o2js.com/
$: npm install -g scotch-blog
$: cd blog
$: sudo scotch serve 8080
</pre>

<p>Then going to <em><a href="http://localhost:8080/dashboard/install">http://localhost:8080/dashboard/install</a></em> will install <strong>scotch</strong> for you.</p>
<blockquote>
<p>Make sure that you have <strong><a href="http://www.mongodb.org/">MongoDB</a></strong> installed, before installing <strong>scotch</strong>.</p>
</blockquote>
<h3>Generating Static Blog Content</h3>
<p>This is also as easy as calling <code>scotch generate</code> in the blog folder.</p>
<p>This will create a static copy of the site under a folder named <em>*static</em>.</p>
<h3>That&#39;s It</h3>
<p>In this post, I tried to share&hellip;</p>
<ul>
<li>How I set up a minimalist <strong>node.js</strong> blog;</li>
<li>How I created a <strong>static</strong> version of that blog;</li>
<li>How I served this static content through <strong>NGINX</strong>;</li>
<li>And how I <strong>reverse-proxied</strong> to that blog through <strong>IIS</strong>.</li>
</ul>
<p>The end result of all this effort is this very blog that you&#39;re reading right now <strong>;)</strong>.</p>
<blockquote>
<p>Whenever I write a new blog article, I also create a markdown file for it.<br>
I synchronize these markdown files and other static content with the <a href="https://github.com/v0lkan/o2js.com">blog&#39;s github repository</a>.</p>
</blockquote>
<p>There are a bunch of issues that I&#39;ve opened already, to enhance this blog&#39;s functionality further. <a href="http://blog.o2js.com/hello-node-js-blogging-world">As I&#39;ve said earlier</a>, this is a very long transition project. And if you have any ideas, I&#39;d love to learn about them.</p>

  <blockquote>
    Do you have something to say? Have I missed anything?<br>
    Send your comments and suggestions to <a href="mailto:volkan@o2js.com">volkan@o2js.com</a>.
  </blockquote>
  <div class="byline">
    by <a href="http://volkan.io/">Volkan Özçelik</a> on 08.03.13
  </div>
</div>



<div class="menu right">
  <a href="/hello-node-js-blogging-world" class="btn btn-grey">&laquo; older post</a>
  <a href="javascript://" class="btn btn-grey btn-disabled">newer post &raquo;</a>
</div>




    </div>
  </body>
</html>
